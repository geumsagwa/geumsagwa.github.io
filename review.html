<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서평 - 생각을 잇다</title>
        <script>if(localStorage.getItem('theme')==='light')document.documentElement.classList.add('light-mode')</script>
<link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<nav class="menu-bar">
    <a href="index.html" class="menu-logo">
        <span class="menu-logo-text">생각을 잇다</span>
    </a>
    <ul class="menu-list">
        <li><a href="index.html">Home</a></li>
        <li><a href="library.html">Library</a></li>
        <li class="active"><a href="blog.html">Blog</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="board.html">Board</a></li>
        <li class="diary-menu" style="display:none"><a href="diary.html">Diary</a></li>
    </ul>
    <div class="auth-area" id="auth-area"></div>
</nav>

<div class="review-container">

    <div class="review-header">
        <a href="blog.html" class="review-back">← Blog</a>
        <span class="review-category">Book Review</span>
    </div>

    <article class="review-article" id="review-article" style="display:none;">

        <div class="review-hero">
            <div class="review-cover" id="review-cover" style="display:none;">
                <img id="cover-img" src="" alt="">
            </div>
            <div class="review-book-info">
                <p class="review-title-label" id="review-title-label" style="display:none;"></p>
                <h1 class="review-book-title" id="book-title"></h1>
                <div class="review-book-meta" id="book-meta"></div>
                <time class="review-date" id="review-date"></time>
            </div>
        </div>

        <div class="review-body" id="review-body"></div>

        <div class="review-end-mark">✦</div>

        <div style="margin-top:2rem; text-align:right;">
            <a id="edit-link" href="#" class="blog-write-btn" style="display:none;">수정</a>
        </div>

    </article>

    <div id="review-loading" style="text-align:center; padding:10vh 0;">
        <p style="color:#555; font-family:'GyeonggiBatang',sans-serif; font-size:0.9rem;">불러오는 중...</p>
    </div>

    <div id="review-error" style="display:none; text-align:center; padding:10vh 0;">
        <p style="color:#555; font-family:'GyeonggiBatang',sans-serif; font-size:1rem;">서평을 찾을 수 없습니다.</p>
        <a href="blog.html" style="color:#8f7d60; font-family:'GyeonggiBatang',sans-serif; font-size:0.85rem; text-decoration:none;">← 목록으로 돌아가기</a>
    </div>

</div>

<script src="supabase-config.js"></script>
<script src="auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    if (!id) {
        showError();
        return;
    }

    const { data, error } = await _supabase
        .from('book_reviews').select('*').eq('id', id).single();

    if (error || !data) {
        showError();
        return;
    }

    document.title = `${data.review_title || data.title} - 생각을 잇다`;

    document.getElementById('book-title').textContent = data.title;

    if (data.review_title && data.review_title !== data.title) {
        const rtLabel = document.getElementById('review-title-label');
        rtLabel.textContent = data.review_title;
        rtLabel.style.display = '';
    }

    const metaEl = document.getElementById('book-meta');
    const metaParts = [data.author];
    if (data.translator) metaParts.push(data.translator + ' 역');
    if (data.year) metaParts.push(String(data.year));
    if (data.publisher) metaParts.push(data.publisher);
    metaEl.innerHTML = metaParts
        .map(p => `<span>${p}</span>`)
        .join('<span class="meta-sep">/</span>');

    const dateStr = new Date(data.created_at).toLocaleDateString('ko-KR', {
        year: 'numeric', month: '2-digit', day: '2-digit'
    }).replace(/\./g, '.').replace(/\s/g, ' ');
    document.getElementById('review-date').textContent = dateStr;

    if (data.cover_url) {
        const coverDiv = document.getElementById('review-cover');
        coverDiv.style.display = '';
        const img = document.getElementById('cover-img');
        img.src = data.cover_url;
        img.alt = data.title + ' 표지';
    }

    const md = data.body_markdown || '';
    const html = renderMarkdown(md);
    document.getElementById('review-body').innerHTML = html;

    document.getElementById('review-loading').style.display = 'none';
    document.getElementById('review-article').style.display = '';

    const user = await getCurrentUser();
    if (user) {
        const editLink = document.getElementById('edit-link');
        editLink.href = `review-editor.html?id=${id}`;
        editLink.style.display = 'inline-block';
    }
});

function renderMarkdown(md) {
    let processed = md;

    const authorRegex = /:::author\n([\s\S]*?)\n:::/g;
    processed = processed.replace(authorRegex, (_, content) => {
        return `<div class="review-author-section">\n\n${content}\n\n</div>`;
    });

    const pageRefRegex = /\(p\.(\d+)\)/g;
    processed = processed.replace(pageRefRegex, '<span class="page-ref">(p.$1)</span>');

    marked.setOptions({
        breaks: true,
        gfm: true,
    });

    let html = marked.parse(processed);

    const authorEnd = html.indexOf('</div><!-- review-author-section -->') !== -1
        ? html.indexOf('</div><!-- review-author-section -->') + 35
        : html.indexOf('</div>\n');

    let foundFirst = false;
    html = html.replace(/<p>(?!<)/g, (match, offset) => {
        if (!foundFirst && offset > authorEnd) {
            foundFirst = true;
            return '<p class="review-first-para">';
        }
        return match;
    });

    return html;
}

function showError() {
    document.getElementById('review-loading').style.display = 'none';
    document.getElementById('review-error').style.display = '';
}
</script>

</body>
</html>
