<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 - 생각을 잇다</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- 상단 메뉴바 영역 -->
<nav class="menu-bar">
    <a href="index.html" class="menu-logo">
        <span class="menu-logo-text">생각을 잇다</span>
    </a>
    <ul class="menu-list">
        <li><a href="index.html">Home</a></li>
        <li><a href="library.html">Library</a></li>
        <li><a href="blog.html">Blog</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="board.html">Board</a></li>
        <li class="diary-menu" style="display:none"><a href="diary.html">Diary</a></li>
    </ul>
    <div class="auth-area" id="auth-area"></div>
</nav>

<!-- 로그인/회원가입 영역 -->
<div class="auth-container">

    <!-- 인증 카드 -->
    <div class="auth-card">

        <!-- 탭 전환 -->
        <div class="auth-tabs">
            <button class="auth-tab active" id="tab-login" onclick="switchTab('login')">로그인</button>
            <button class="auth-tab" id="tab-signup" onclick="switchTab('signup')">회원가입</button>
        </div>

        <!-- 로그인 폼 -->
        <form class="auth-form active" id="form-login" onsubmit="handleLogin(event)">
            <div class="auth-field">
                <label class="auth-label" for="login-email">이메일</label>
                <input class="auth-input" type="email" id="login-email" placeholder="example@email.com" required>
            </div>
            <div class="auth-field">
                <label class="auth-label" for="login-password">비밀번호</label>
                <input class="auth-input" type="password" id="login-password" placeholder="비밀번호를 입력하세요" required>
            </div>
            <div class="auth-message" id="login-message"></div>
            <button class="auth-submit" type="submit" id="login-submit">로그인</button>

            <!-- 소셜 로그인 -->
            <div class="auth-social">
                <button type="button" class="auth-social-btn auth-social-google" onclick="socialLogin('google')">
                    <svg class="auth-social-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Google로 계속하기
                </button>
                <button type="button" class="auth-social-btn auth-social-kakao" onclick="socialLogin('kakao')">
                    <svg class="auth-social-icon" viewBox="0 0 24 24"><path fill="#3C1E1E" d="M12 3C6.48 3 2 6.36 2 10.5c0 2.64 1.74 4.98 4.38 6.32l-1.12 4.08c-.1.36.32.64.62.42L10.38 18c.54.06 1.08.1 1.62.1 5.52 0 10-3.36 10-7.5S17.52 3 12 3z"/></svg>
                    카카오로 계속하기
                </button>
                <button type="button" class="auth-social-btn auth-social-github" onclick="socialLogin('github')">
                    <svg class="auth-social-icon" viewBox="0 0 24 24"><path fill="#ccc" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0 1 12 6.836c.85.004 1.705.115 2.504.337 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/></svg>
                    GitHub로 계속하기
                </button>
            </div>
        </form>

        <!-- 회원가입 폼 -->
        <form class="auth-form" id="form-signup" onsubmit="handleSignUp(event)">
            <div class="auth-field">
                <label class="auth-label" for="signup-nickname">닉네임</label>
                <input class="auth-input" type="text" id="signup-nickname" placeholder="사이트에서 사용할 이름" maxlength="20" required>
            </div>
            <div class="auth-field">
                <label class="auth-label" for="signup-email">이메일</label>
                <input class="auth-input" type="email" id="signup-email" placeholder="example@email.com" required>
            </div>
            <div class="auth-field">
                <label class="auth-label" for="signup-password">비밀번호</label>
                <input class="auth-input" type="password" id="signup-password" placeholder="6자 이상" minlength="6" required>
            </div>
            <div class="auth-field">
                <label class="auth-label" for="signup-password-confirm">비밀번호 확인</label>
                <input class="auth-input" type="password" id="signup-password-confirm" placeholder="비밀번호를 다시 입력하세요" minlength="6" required>
            </div>
            <div class="auth-message" id="signup-message"></div>
            <button class="auth-submit" type="submit" id="signup-submit">회원가입</button>

            <!-- 소셜 간편가입 -->
            <div class="auth-social">
                <button type="button" class="auth-social-btn auth-social-google" onclick="socialLogin('google')">
                    <svg class="auth-social-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Google로 시작하기
                </button>
                <button type="button" class="auth-social-btn auth-social-kakao" onclick="socialLogin('kakao')">
                    <svg class="auth-social-icon" viewBox="0 0 24 24"><path fill="#3C1E1E" d="M12 3C6.48 3 2 6.36 2 10.5c0 2.64 1.74 4.98 4.38 6.32l-1.12 4.08c-.1.36.32.64.62.42L10.38 18c.54.06 1.08.1 1.62.1 5.52 0 10-3.36 10-7.5S17.52 3 12 3z"/></svg>
                    카카오로 시작하기
                </button>
                <button type="button" class="auth-social-btn auth-social-github" onclick="socialLogin('github')">
                    <svg class="auth-social-icon" viewBox="0 0 24 24"><path fill="#ccc" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0 1 12 6.836c.85.004 1.705.115 2.504.337 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/></svg>
                    GitHub로 시작하기
                </button>
            </div>
        </form>

    </div>

</div>

<script src="supabase-config.js"></script>
<script>
    // 탭 전환
    function switchTab(tab) {
        const loginTab = document.getElementById('tab-login');
        const signupTab = document.getElementById('tab-signup');
        const loginForm = document.getElementById('form-login');
        const signupForm = document.getElementById('form-signup');

        if (tab === 'login') {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            loginForm.classList.add('active');
            signupForm.classList.remove('active');
        } else {
            loginTab.classList.remove('active');
            signupTab.classList.add('active');
            loginForm.classList.remove('active');
            signupForm.classList.add('active');
        }

        // 메시지 초기화
        document.getElementById('login-message').textContent = '';
        document.getElementById('signup-message').textContent = '';
    }

    // 메시지 표시
    function showMessage(elementId, text, isError) {
        const el = document.getElementById(elementId);
        el.textContent = text;
        el.className = 'auth-message ' + (isError ? 'auth-error' : 'auth-success');
    }

    // 로그인 처리
    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        const btn = document.getElementById('login-submit');

        btn.disabled = true;
        btn.textContent = '로그인 중...';

        const { data, error } = await _supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) {
            let msg = '로그인에 실패했습니다.';
            if (error.message.includes('Invalid login credentials')) {
                msg = '이메일 또는 비밀번호가 올바르지 않습니다.';
            } else if (error.message.includes('Email not confirmed')) {
                msg = '이메일 인증이 완료되지 않았습니다. 메일함을 확인해주세요.';
            }
            showMessage('login-message', msg, true);
        } else {
            showMessage('login-message', '로그인 성공! 이동 중...', false);
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 800);
        }

        btn.disabled = false;
        btn.textContent = '로그인';
    }

    // 회원가입 처리
    async function handleSignUp(e) {
        e.preventDefault();
        const nickname = document.getElementById('signup-nickname').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const password = document.getElementById('signup-password').value;
        const passwordConfirm = document.getElementById('signup-password-confirm').value;
        const btn = document.getElementById('signup-submit');

        // 비밀번호 확인
        if (password !== passwordConfirm) {
            showMessage('signup-message', '비밀번호가 일치하지 않습니다.', true);
            return;
        }

        btn.disabled = true;
        btn.textContent = '가입 중...';

        const { data, error } = await _supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: { nickname: nickname }
            }
        });

        if (error) {
            let msg = '회원가입에 실패했습니다.';
            if (error.message.includes('already registered')) {
                msg = '이미 가입된 이메일입니다.';
            } else if (error.message.includes('Password')) {
                msg = '비밀번호는 6자 이상이어야 합니다.';
            }
            showMessage('signup-message', msg, true);
        } else {
            // Supabase 설정에 따라 이메일 인증이 필요할 수 있음
            if (data.user && data.user.identities && data.user.identities.length === 0) {
                showMessage('signup-message', '이미 가입된 이메일입니다.', true);
            } else {
                showMessage('signup-message', '가입 완료! 이메일 인증 후 로그인해주세요.', false);
                // 폼 초기화
                document.getElementById('form-signup').reset();
            }
        }

        btn.disabled = false;
        btn.textContent = '회원가입';
    }

    // 소셜 로그인 처리
    async function socialLogin(provider) {
        const { data, error } = await _supabase.auth.signInWithOAuth({
            provider: provider,
            options: {
                redirectTo: window.location.origin + '/index.html'
            }
        });

        if (error) {
            // 현재 활성 탭에 따라 메시지 표시
            const activeTab = document.querySelector('.auth-tab.active').id;
            const msgId = activeTab === 'tab-login' ? 'login-message' : 'signup-message';
            showMessage(msgId, '소셜 로그인에 실패했습니다: ' + error.message, true);
        }
    }

    // 이미 로그인된 경우 홈으로 이동
    (async () => {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) {
            window.location.href = 'index.html';
        }
    })();
</script>

</body>
</html>
