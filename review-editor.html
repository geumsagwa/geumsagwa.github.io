<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서평 에디터 - 생각을 잇다</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <style>
        .re-form { width: 100%; max-width: 780px; }
        .re-row { display: flex; gap: 1rem; margin-bottom: 1.2rem; }
        .re-row.full { flex-direction: column; }
        .re-field { flex: 1; display: flex; flex-direction: column; gap: 0.35rem; }
        .re-label {
            font-family: 'GyeonggiBatang', 'Malgun Gothic', sans-serif;
            font-weight: 700; font-size: 0.8rem; color: #888;
            letter-spacing: 0.05em;
        }
        .re-label .optional { font-weight: 400; font-size: 0.7rem; color: #444; }
        .re-input {
            width: 100%; padding: 0.6rem 0.8rem;
            background: #111; border: 1px solid #2a2a2a; border-radius: 4px;
            color: #ccc; font-family: 'GyeonggiBatang', 'Malgun Gothic', sans-serif;
            font-size: 0.95rem; transition: border-color 0.3s ease;
        }
        .re-input:focus { outline: none; border-color: #555; }

        .EasyMDEContainer .CodeMirror {
            background: #111; color: #ccc; border-color: #2a2a2a;
            font-family: 'GyeonggiBatang', 'Malgun Gothic', sans-serif;
            font-size: 1rem; line-height: 1.9;
        }
        .EasyMDEContainer .CodeMirror-focused { border-color: #555; }
        .editor-toolbar { background: #0a0a0a; border-color: #2a2a2a; }
        .editor-toolbar button { color: #888 !important; }
        .editor-toolbar button:hover { background: #222 !important; }
        .editor-toolbar button.active { background: #333 !important; color: #fff !important; }
        .editor-toolbar i.separator { border-color: #333 !important; }
        .editor-statusbar { color: #555; }
        .EasyMDEContainer .CodeMirror .CodeMirror-cursor { border-left-color: #ccc; }
        .EasyMDEContainer .CodeMirror .CodeMirror-selected { background: rgba(143,125,96,0.2); }
        .editor-preview { background: #111; color: #aaa; }
        .editor-preview h2 { color: #ccc; border-bottom: 1px solid rgba(143,125,96,0.2); padding-bottom: 0.4rem; }
        .editor-preview blockquote { border-left: 2px solid #5a4a30; color: #999; padding: 0.5rem 1rem; }
        .editor-preview strong { color: #ddd; }
        .editor-preview em { color: #b39768; }
        .editor-preview hr { border: none; height: 1px; background: #333; }

        .re-actions { display: flex; gap: 1rem; margin-top: 1.5rem; margin-bottom: 3rem; justify-content: flex-end; }
        .re-btn {
            font-family: 'GyeonggiBatang', 'Malgun Gothic', sans-serif;
            font-weight: 400; font-size: 0.9rem; padding: 0.6rem 1.8rem;
            border-radius: 4px; cursor: pointer; transition: all 0.3s ease;
        }
        .re-btn-cancel { color: #888; background: none; border: 1px solid #333; }
        .re-btn-cancel:hover { color: #fff; border-color: #666; }
        .re-btn-save { color: #000; background: #8f7d60; border: none; font-weight: 700; }
        .re-btn-save:hover { background: #dabb7e; }
        .re-btn-save:disabled { background: #555; cursor: not-allowed; }
        .re-btn-delete { color: #c0392b; background: none; border: 1px solid #c0392b33; }
        .re-btn-delete:hover { border-color: #c0392b; background: rgba(192,57,43,0.08); }

        .re-message {
            font-family: 'GyeonggiBatang', 'Malgun Gothic', sans-serif;
            font-size: 0.8rem; text-align: center; min-height: 1.2rem; margin-top: 0.8rem;
        }
        .re-message.error { color: #c0392b; }
        .re-message.success { color: #8f7d60; }

        @media (max-width: 768px) {
            .re-row { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>

<nav class="menu-bar">
    <a href="index.html" class="menu-logo">
        <span class="menu-logo-text">생각을 잇다</span>
    </a>
    <ul class="menu-list">
        <li><a href="index.html">Home</a></li>
        <li><a href="library.html">Library</a></li>
        <li class="active"><a href="blog.html">Blog</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="board.html">Board</a></li>
        <li class="diary-menu" style="display:none"><a href="diary.html">Diary</a></li>
    </ul>
    <div class="auth-area" id="auth-area"></div>
</nav>

<div class="review-container">
    <div class="review-header">
        <a href="blog.html" class="review-back">← Blog</a>
        <span class="review-category" id="page-mode">새 서평 작성</span>
    </div>

    <div class="re-form" id="editor-form">
        <div class="re-row">
            <div class="re-field">
                <label class="re-label">서평 제목</label>
                <input class="re-input" id="f-review-title" placeholder="예: 하루키! 인생을 달리다">
            </div>
        </div>
        <div class="re-row">
            <div class="re-field">
                <label class="re-label">책 제목</label>
                <input class="re-input" id="f-title" placeholder="예: 달리기를 말할 때 내가 하고 싶은 이야기">
            </div>
        </div>
        <div class="re-row">
            <div class="re-field">
                <label class="re-label">저자</label>
                <input class="re-input" id="f-author" placeholder="예: 무라카미 하루키">
            </div>
            <div class="re-field">
                <label class="re-label">역자 <span class="optional">(선택)</span></label>
                <input class="re-input" id="f-translator" placeholder="예: 임홍빈">
            </div>
        </div>
        <div class="re-row">
            <div class="re-field">
                <label class="re-label">출판년</label>
                <input class="re-input" id="f-year" type="number" placeholder="예: 2009">
            </div>
            <div class="re-field">
                <label class="re-label">출판사</label>
                <input class="re-input" id="f-publisher" placeholder="예: 문학사상">
            </div>
        </div>
        <div class="re-row">
            <div class="re-field">
                <label class="re-label">표지 이미지 URL <span class="optional">(선택)</span></label>
                <input class="re-input" id="f-cover-url" placeholder="https://...">
            </div>
        </div>
        <div class="re-row">
            <div class="re-field">
                <label class="re-label">카드 배경 이미지 URL <span class="optional">(선택)</span></label>
                <input class="re-input" id="f-card-image" placeholder="https://... (블로그 카드 배경)">
            </div>
        </div>
        <div class="re-row">
            <div class="re-field">
                <label class="re-label">한 줄 요약 <span class="optional">(카드에 표시)</span></label>
                <input class="re-input" id="f-excerpt" placeholder="예: 진심을 담아 담담히 서술하는 러너이자 소설가의 회고.">
            </div>
        </div>

        <div class="re-row full">
            <label class="re-label">본문 (마크다운)</label>
            <textarea id="f-body"></textarea>
        </div>

        <div class="re-message" id="re-message"></div>

        <div class="re-actions">
            <button class="re-btn re-btn-delete" id="btn-delete" style="display:none" onclick="deleteReview()">삭제</button>
            <div style="flex:1"></div>
            <a href="blog.html" class="re-btn re-btn-cancel">취소</a>
            <button class="re-btn re-btn-save" id="btn-save" onclick="saveReview()">저장</button>
        </div>
    </div>
</div>

<script src="supabase-config.js"></script>
<script src="auth.js"></script>
<script>
let easyMDE;
let editId = null;

document.addEventListener('DOMContentLoaded', async () => {
    easyMDE = new EasyMDE({
        element: document.getElementById('f-body'),
        spellChecker: false,
        autosave: { enabled: false },
        placeholder: '마크다운으로 서평을 작성하세요...\n\n## 저자 소개\n\n:::author\n저자 소개 내용...\n:::\n\n## 책의 내용\n\n본문...',
        toolbar: [
            'bold', 'italic', 'heading-2', '|',
            'quote', 'horizontal-rule', '|',
            'preview', 'side-by-side', '|',
            'guide'
        ],
        status: ['lines', 'words'],
        minHeight: '350px',
    });

    const params = new URLSearchParams(window.location.search);
    editId = params.get('id');

    if (editId) {
        document.getElementById('page-mode').textContent = '서평 수정';
        document.getElementById('btn-delete').style.display = 'inline-block';
        await loadReview(editId);
    }
});

async function loadReview(id) {
    const { data, error } = await _supabase
        .from('book_reviews').select('*').eq('id', id).single();

    if (error || !data) {
        showMsg('서평을 불러올 수 없습니다.', true);
        return;
    }

    document.getElementById('f-review-title').value = data.review_title || '';
    document.getElementById('f-title').value = data.title || '';
    document.getElementById('f-author').value = data.author || '';
    document.getElementById('f-translator').value = data.translator || '';
    document.getElementById('f-year').value = data.year || '';
    document.getElementById('f-publisher').value = data.publisher || '';
    document.getElementById('f-cover-url').value = data.cover_url || '';
    document.getElementById('f-card-image').value = data.card_image_url || '';
    document.getElementById('f-excerpt').value = data.excerpt || '';
    easyMDE.value(data.body_markdown || '');
}

async function saveReview() {
    const btn = document.getElementById('btn-save');
    btn.disabled = true;

    const title = document.getElementById('f-title').value.trim();
    const author = document.getElementById('f-author').value.trim();
    const body = easyMDE.value().trim();

    if (!title || !author || !body) {
        showMsg('책 제목, 저자, 본문은 필수입니다.', true);
        btn.disabled = false;
        return;
    }

    const row = {
        title,
        author,
        translator: document.getElementById('f-translator').value.trim() || null,
        year: parseInt(document.getElementById('f-year').value) || null,
        publisher: document.getElementById('f-publisher').value.trim() || null,
        cover_url: document.getElementById('f-cover-url').value.trim() || null,
        review_title: document.getElementById('f-review-title').value.trim() || title,
        excerpt: document.getElementById('f-excerpt').value.trim() || null,
        body_markdown: body,
        card_image_url: document.getElementById('f-card-image').value.trim() || null,
        updated_at: new Date().toISOString(),
    };

    let result;
    if (editId) {
        result = await _supabase.from('book_reviews').update(row).eq('id', editId);
    } else {
        result = await _supabase.from('book_reviews').insert(row).select();
    }

    if (result.error) {
        showMsg('저장 실패: ' + result.error.message, true);
        btn.disabled = false;
        return;
    }

    showMsg('저장되었습니다!', false);
    setTimeout(() => {
        const savedId = editId || result.data?.[0]?.id;
        if (savedId) {
            window.location.href = `review.html?id=${savedId}`;
        } else {
            window.location.href = 'blog.html';
        }
    }, 800);
}

async function deleteReview() {
    if (!editId) return;
    if (!confirm('이 서평을 삭제하시겠습니까?')) return;

    const { error } = await _supabase.from('book_reviews').delete().eq('id', editId);
    if (error) {
        showMsg('삭제 실패: ' + error.message, true);
        return;
    }
    window.location.href = 'blog.html';
}

function showMsg(text, isError) {
    const el = document.getElementById('re-message');
    el.textContent = text;
    el.className = 're-message ' + (isError ? 'error' : 'success');
}
</script>

</body>
</html>
